<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-button fill="clear" [routerLink]="['/dashboard']">
        <ion-icon slot="icon-only" name="home-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-title>Lista de Animales</ion-title>
    <ion-buttons slot="end">
      <ion-button fill="clear" (click)="goToMap()">
        <ion-icon slot="icon-only" name="map-outline"></ion-icon>
      </ion-button>
      @if (canCreateAnimals()) {
      <!-- Bulk operations menu -->
      <ion-button id="bulk-operations-trigger" fill="clear">
        <ion-icon slot="icon-only" name="ellipsis-vertical"></ion-icon>
      </ion-button>
      <ion-popover trigger="bulk-operations-trigger" trigger-action="click">
        <ng-template>
          <ion-content>
            <ion-list>
              <ion-item button [routerLink]="['/animal/create']">
                <ion-icon slot="start" name="add-outline"></ion-icon>
                <ion-label>Crear Animal</ion-label>
              </ion-item>
              <ion-item button [routerLink]="['/animal/bulk-create']">
                <ion-icon slot="start" name="duplicate-outline"></ion-icon>
                <ion-label>Crear en Lote</ion-label>
              </ion-item>
              <ion-item button [routerLink]="['/animal/bulk-edit']">
                <ion-icon slot="start" name="create-outline"></ion-icon>
                <ion-label>Edici√≥n Masiva</ion-label>
              </ion-item>
            </ion-list>
          </ion-content>
        </ng-template>
      </ion-popover>
      <ion-button [routerLink]="['/animal/create']" fill="clear">
        <ion-icon slot="icon-only" name="add-outline"></ion-icon>
      </ion-button>
      } @else {
      <ion-badge color="medium">Solo lectura</ion-badge>
      }
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content>
  <!-- Filters Section -->
  <app-animal-filters
    [speciesList]="speciesList()"
    [regionsList]="regionsList()"
    [initialSpecies]="speciesFilter()"
    [initialRegion]="regionFilter()"
    [initialFromDate]="fromDate()"
    [initialToDate]="toDate()"
    (filtersApplied)="onFiltersApplied($event)"
    (filtersCleared)="onFiltersCleared()">
  </app-animal-filters>

  <!-- Animal List -->
  <div class="animals-container ion-padding">
    @if (loading()) {
      <div class="loading-state">
        <ion-spinner></ion-spinner>
        <p>Cargando animales...</p>
      </div>
    } @else if (filteredAnimals().length === 0 && animals().length > 0) {
      <div class="empty-state ion-padding ion-text-center">
        <ion-icon name="filter-outline" size="large"></ion-icon>
        <h3>No se encontraron animales</h3>
        <p>No hay animales que coincidan con los filtros seleccionados.</p>
        <ion-button fill="clear" (click)="onFiltersCleared()">
          Limpiar filtros
        </ion-button>
      </div>
    } @else if (animals().length === 0) {
      <div class="empty-state ion-padding ion-text-center">
        <ion-icon name="paw-outline" size="large"></ion-icon>
        <h3>No hay animales registrados</h3>
        <p>Comienza creando tu primer animal.</p>
        @if (canCreateAnimals()) {
        <ion-button expand="block" [routerLink]="['/animal/create']">
          <ion-icon slot="start" name="add-outline"></ion-icon>
          Crear Animal
        </ion-button>
        } @else {
        <ion-badge color="warning">Permisos insuficientes para crear animales</ion-badge>
        }
      </div>
    } @else {
      <ion-grid>
        @for (animal of filteredAnimals(); track animal.id) {
        <ion-row>
          <ion-col size="12" size-md="6" size-lg="4">
            <ion-card>
              <ion-card-header>
                <ion-card-title>{{ animal.breed }}</ion-card-title>
              </ion-card-header>
              <ion-card-content>
                <ion-item lines="none">
                  <ion-label>
                    <p>
                      <strong>Nacimiento:</strong> {{ animal.birth_date | date:'short' }}
                    </p>
                    <p><strong>Estado:</strong> {{ animal.status }}</p>
                  </ion-label>
                </ion-item>

                <div class="action-buttons">
                  <ion-button
                    fill="outline"
                    size="small"
                    (click)="goToSpecificAnimal(animal)"
                  >
                    <ion-icon slot="start" name="eye-outline"></ion-icon>
                    Ver
                  </ion-button>
                  @if (canEditAnimals()) {
                  <ion-button fill="clear" size="small" (click)="goToEdit(animal)">
                    <ion-icon slot="start" name="pencil-outline"></ion-icon>
                    Editar
                  </ion-button>
                  }
                </div>
              </ion-card-content>
            </ion-card>
          </ion-col>
        </ion-row>
        }
      </ion-grid>
    }
  </div>

  <!-- Floating Action Button -->
  @if (canCreateAnimals()) {
  <ion-fab slot="fixed" vertical="bottom" horizontal="end">
    <ion-fab-button [routerLink]="['/animal/create']">
      <ion-icon name="add-outline"></ion-icon>
    </ion-fab-button>
  </ion-fab>
  }
</ion-content>
